generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// SYSTEM SETTINGS
// ============================================

model SystemSetting {
  key       String   @id
  value     String   @db.Text
  isPrivate Boolean  @default(false)
  updatedAt DateTime @updatedAt

  @@map("system_settings")
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  password      String?
  name          String?
  image         String?
  role          UserRole  @default(PARENT)
  roleSelected  Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  accounts      Account[]
  sessions      Session[]
  players       Player[]         // Players this user manages (legacy - use guardians)
  subscription  Subscription?
  ownedPrograms Program[]        // Programs this user owns (program director)
  guardians     Guardian[]       // Players this user is guardian of
  sentInvites   GuardianInvite[] // Co-parent invites sent by this user
  recruitingEmails RecruitingEmail[]
  tosAcceptances   TosAcceptance[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model PasswordResetToken {
  id        String    @id @default(cuid())
  token     String    @unique @default(cuid())
  email     String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@map("password_reset_tokens")
}

enum UserRole {
  PLAYER
  PARENT
  SCOREKEEPER
  PROGRAM_DIRECTOR
  ADMIN
}

model TosAcceptance {
  id         String   @id @default(cuid())
  userId     String
  agreedAt   DateTime @default(now())
  version    String   @default("1.0")
  touchpoint String   // "account_creation" or "checkout"

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("tos_acceptances")
}

// ============================================
// SUBSCRIPTION / PAYMENTS
// ============================================

model Subscription {
  id                   String             @id @default(cuid())
  userId               String             @unique
  user                 User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  plan                 SubscriptionPlan
  status               SubscriptionStatus @default(ACTIVE)

  stripeCustomerId     String?
  stripeSubscriptionId String?
  stripePriceId        String?
  childCount           Int                @default(1) // Number of children covered by family plan

  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean            @default(false)

  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  @@map("subscriptions")
}

enum SubscriptionPlan {
  ANNUAL      // $75/year
  SEMI_ANNUAL // $50/6 months
  MONTHLY     // $10/month
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  EXPIRED
  TRIALING
}

enum GuardianRole {
  PRIMARY    // First parent who claimed the player
  SECONDARY  // Co-parent invited by primary
  PLAYER     // Player invited to manage their own profile
}

// ============================================
// GUARDIANS (Family Plan - User <-> Player)
// ============================================

model Guardian {
  id        String       @id @default(cuid())
  userId    String
  playerId  String
  role      GuardianRole @default(PRIMARY)
  isPayer   Boolean      @default(false) // True if this guardian pays for the subscription

  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  // Relations
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  player    Player       @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([userId, playerId])
  @@map("guardians")
}

model GuardianInvite {
  id         String       @id @default(cuid())
  token      String       @unique @default(cuid())
  email      String
  playerId   String
  invitedBy  String
  role       GuardianRole @default(SECONDARY)
  expiresAt  DateTime
  acceptedAt DateTime?

  createdAt  DateTime     @default(now())

  // Relations
  player     Player       @relation(fields: [playerId], references: [id], onDelete: Cascade)
  inviter    User         @relation(fields: [invitedBy], references: [id], onDelete: Cascade)

  @@map("guardian_invites")
}

// ============================================
// PLAYERS
// ============================================

model Player {
  id              String    @id @default(cuid())
  slug            String    @unique // URL-friendly name (firstname-lastname)

  // Basic Info
  firstName       String
  lastName        String
  email           String?
  phone           String?

  // Physical
  heightFeet      Int?
  heightInches    Int?
  weight          Int?      // in pounds

  // Basketball Info
  primaryPosition Position?
  secondaryPosition Position?
  jerseyNumber    String?

  // School & Location
  school          String?
  city            String?
  state           String?
  graduationYear  Int?      // e.g., 2027

  // Profile
  profilePhoto    String?   // URL
  bio             String?   @db.Text
  gpa             Float?    // Grade Point Average
  transcriptUrl   String?   // PDF URL

  // Verification
  isVerified      Boolean   @default(false)
  verifiedAt      DateTime?
  dateOfBirth     DateTime?
  gradeLevel      Int?      // 6-12

  // Social Links
  twitterHandle   String?
  instagramHandle String?
  hudlUrl         String?
  youtubeUrl      String?
  highlightUrl    String?
  maxPrepsUrl     String?

  // Status
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  userId          String?   // User who manages this profile (legacy - use guardians)
  user            User?     @relation(fields: [userId], references: [id])

  // Exposure Events Integration
  exposureId      Int?      @unique // ID in Exposure Events system

  teamRosters     TeamRoster[]
  gameStats       GameStats[]
  achievements    Achievement[]
  media           Media[]
  guardians       Guardian[]       // Users who are guardians of this player
  guardianInvites GuardianInvite[] // Pending guardian invites for this player
  recruitingEmailPlayers RecruitingEmailPlayer[]

  @@map("players")
}

enum Position {
  PG  // Point Guard
  SG  // Shooting Guard
  SF  // Small Forward
  PF  // Power Forward
  C   // Center
}

// ============================================
// PROGRAMS (Clubs)
// ============================================

model Program {
  id            String   @id @default(cuid())
  slug          String   @unique
  name          String   // e.g., "Cali Rebels"
  directorName  String?
  directorEmail String?
  directorPhone String?
  logo          String?  // URL
  city          String?
  state         String?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Owner (Program Director)
  ownerId       String?
  owner         User?    @relation(fields: [ownerId], references: [id])

  // Relations
  teams         Team[]

  // Exposure Events Integration
  exposureId      Int?      @unique // Organization ID in Exposure

  @@map("programs")
}

// ============================================
// TEAMS
// ============================================

model Team {
  id          String   @id @default(cuid())
  slug        String   @unique

  name        String
  logo        String?  // URL

  // Location
  city        String?
  state       String?

  // Division/Classification (combined, e.g. "EPL 17", "14U Gold", "17U")
  division    String?
  gender      String?  // "Boys" or "Girls"

  // Season Record
  wins        Int      @default(0)
  losses      Int      @default(0)

  // Contact
  coachName   String?
  coachEmail  String?
  coachPhone  String?

  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Program relation
  programId   String?
  program     Program? @relation(fields: [programId], references: [id], onDelete: SetNull)

  // Relations
  roster      TeamRoster[]
  homeGames   Game[]       @relation("HomeTeam")
  awayGames   Game[]       @relation("AwayTeam")
  eventTeams  EventTeam[]

  // Exposure Events Integration
  exposureId      Int?      @unique // Team ID in Exposure

  @@map("teams")
}

model TeamRoster {
  id        String   @id @default(cuid())
  teamId    String
  playerId  String

  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  player    Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)

  jerseyNumber String?
  isStarter    Boolean @default(false)
  isCaptain    Boolean @default(false)

  joinedAt  DateTime @default(now())
  leftAt    DateTime?

  @@unique([teamId, playerId])
  @@map("team_rosters")
}

// ============================================
// EVENTS (Tournaments, Leagues)
// ============================================

model Event {
  id          String      @id @default(cuid())
  slug        String      @unique

  name        String
  type        EventType
  description String?     @db.Text

  // Location
  venue       String?
  address     String?
  city        String?
  state       String?

  // Dates
  startDate            DateTime
  endDate              DateTime
  registrationDeadline DateTime?

  // Details
  divisions   String[]    // e.g., ["EPL 17", "EPL 16", "14U Gold"]
  entryFee    Decimal?    @db.Decimal(10, 2)

  // Media
  bannerImage String?
  flyerImage  String?     // 1080x1440 flyer image

  isPublished     Boolean     @default(false)
  isNcaaCertified Boolean     @default(false)
  isActive        Boolean     @default(true)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relations
  games                Game[]
  teams                EventTeam[]
  awards               EventAward[]
  venues               Venue[]
  brackets             Bracket[]
  constraints          ScheduleConstraint[]
  collegeRegistrations EventCollegeRegistration[]

  // Exposure Events Integration
  exposureId      Int?      @unique // Event ID in Exposure

  @@map("events")
}

enum EventType {
  TOURNAMENT
  LEAGUE
  SHOWCASE
  CAMP
}

enum BracketType {
  SINGLE_ELIM
  DOUBLE_ELIM
  POOL_PLAY
  ROUND_ROBIN
}

enum ConstraintType {
  NO_CONFLICT
  MIN_REST
  VENUE_BLOCK
}

model EventTeam {
  id        String   @id @default(cuid())
  eventId   String
  teamId    String

  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  // Pool/Bracket placement
  pool      String?  // e.g., "Pool A"
  seed      Int?

  // Event-specific record
  eventWins   Int    @default(0)
  eventLosses Int    @default(0)
  pointsFor   Int    @default(0)
  pointsAgainst Int  @default(0)

  registeredAt DateTime @default(now())

  // Director-submitted scheduling preferences
  scheduleRequests Json?

  @@unique([eventId, teamId])
  @@map("event_teams")
}

model EventAward {
  id        String     @id @default(cuid())
  eventId   String
  event     Event      @relation(fields: [eventId], references: [id], onDelete: Cascade)

  type      AwardType
  division  String?    // e.g., "17U Elite"

  // Can be associated with player or team
  playerId  String?
  teamId    String?

  createdAt DateTime   @default(now())

  @@map("event_awards")
}

enum AwardType {
  MVP
  ALL_TOURNAMENT_FIRST
  ALL_TOURNAMENT_SECOND
  CHAMPION
  RUNNER_UP
  DEFENSIVE_MVP
  SCORING_LEADER
  ASSISTS_LEADER
  REBOUNDS_LEADER
}

// ============================================
// VENUES & COURTS
// ============================================

model Venue {
  id        String   @id @default(cuid())
  name      String
  address   String?
  city      String?
  state     String?
  zip       String?
  timezone  String   @default("America/Chicago")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  courts    Court[]
  events    Event[]

  @@map("venues")
}

model Court {
  id        String   @id @default(cuid())
  name      String   // e.g., "Court 1", "Main Gym"
  venueId   String

  venue     Venue    @relation(fields: [venueId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  games     Game[]   @relation("AssignedCourt")

  @@unique([venueId, name])
  @@map("courts")
}

// ============================================
// BRACKETS & SCHEDULING
// ============================================

model Bracket {
  id        String      @id @default(cuid())
  eventId   String
  name      String      // e.g., "17U Gold", "15U Silver Championship"
  type      BracketType

  settings  Json?       // Flexible rules: { "gamesPerRound": 2, "seedingMethod": "record" }

  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  // Relations
  event     Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  games     Game[]
  slots     BracketSlot[]

  @@map("brackets")
}

model BracketSlot {
  id          String   @id @default(cuid())
  bracketId   String
  round       Int      // 1 = first round, 2 = second round, etc.
  position    Int      // Position within the round (for visual tree placement)

  gameId      String?  @unique // Optional link to actual game once scheduled

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  bracket     Bracket  @relation(fields: [bracketId], references: [id], onDelete: Cascade)
  game        Game?    @relation(fields: [gameId], references: [id])

  @@unique([bracketId, round, position])
  @@map("bracket_slots")
}

model ScheduleConstraint {
  id          String         @id @default(cuid())
  eventId     String
  type        ConstraintType
  entityType  String         // "TEAM", "COURT", "VENUE"
  entityId    String?        // ID of the team, court, etc.

  params      Json?          // Flexible: { "minMinutes": 60 }, { "blockedTimes": [...] }

  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  // Relations
  event       Event          @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@map("schedule_constraints")
}

// ============================================
// GAMES & STATS
// ============================================

model Game {
  id          String     @id @default(cuid())

  eventId     String?
  event       Event?     @relation(fields: [eventId], references: [id])

  homeTeamId  String
  awayTeamId  String
  homeTeam    Team       @relation("HomeTeam", fields: [homeTeamId], references: [id])
  awayTeam    Team       @relation("AwayTeam", fields: [awayTeamId], references: [id])

  // Scores
  homeScore   Int        @default(0)
  awayScore   Int        @default(0)

  // Game Details
  scheduledAt DateTime
  startedAt   DateTime?
  endedAt     DateTime?

  // Court assignment
  courtId     String?
  assignedCourt Court?   @relation("AssignedCourt", fields: [courtId], references: [id])
  court       String?    // Legacy field - e.g., "Court 1"
  status      GameStatus @default(SCHEDULED)

  // Period tracking
  currentPeriod Int      @default(0)
  periodScores  Json?    // Store period-by-period scores

  // Division/Classification (combined, e.g. "EPL 17", "14U Gold")
  division    String?
  gameType    GameType   @default(POOL)
  poolCode    String?    // e.g., "A", "B" for pool play

  // Bracket info (for tournament games)
  bracketId     String?
  bracket       Bracket?   @relation(fields: [bracketId], references: [id])
  bracketRound  String?    // e.g., "Quarterfinal", "Semifinal", "Championship"
  bracketPosition Int?

  isOfficial  Boolean    @default(false) // Stats are finalized
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relations
  stats       GameStats[]
  statLog     StatLog[]
  bracketSlot BracketSlot?

  // Exposure Events Integration
  exposureId      String?    @unique
  homeTeamLabel   String?    // Descriptive text for bracket games (e.g. "1st in A", "W1 (Championship)")
  awayTeamLabel   String?

  @@map("games")
}

enum GameStatus {
  SCHEDULED
  WARMUP
  IN_PROGRESS
  HALFTIME
  FINAL
  POSTPONED
  CANCELED
}

enum GameType {
  POOL
  BRACKET
  CONSOLATION
  CHAMPIONSHIP
  EXHIBITION
}

model GameStats {
  id        String   @id @default(cuid())
  gameId    String
  playerId  String

  game      Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  player    Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)

  teamId    String   // Which team the player was on for this game

  // Minutes
  minutes   Int      @default(0)

  // Scoring
  points    Int      @default(0)
  fgMade    Int      @default(0)  // Field goals made
  fgAttempted Int    @default(0)  // Field goals attempted
  fg3Made   Int      @default(0)  // 3-pointers made
  fg3Attempted Int   @default(0)  // 3-pointers attempted
  ftMade    Int      @default(0)  // Free throws made
  ftAttempted Int    @default(0)  // Free throws attempted

  // Rebounds
  offRebounds Int    @default(0)
  defRebounds Int    @default(0)
  rebounds    Int    @default(0)  // Total (computed but stored for queries)

  // Other stats
  assists   Int      @default(0)
  steals    Int      @default(0)
  blocks    Int      @default(0)
  turnovers Int      @default(0)
  fouls     Int      @default(0)

  // Plus/Minus
  plusMinus Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([gameId, playerId])
  @@map("game_stats")
}

// Live stat logging (for undo functionality and audit trail)
model StatLog {
  id        String    @id @default(cuid())
  gameId    String
  game      Game      @relation(fields: [gameId], references: [id], onDelete: Cascade)

  playerId  String?   // Optional - null for team-only stats
  teamId    String

  statType  StatType
  value     Int       @default(1)  // Usually 1, but can be 2 or 3 for points

  period    Int       @default(1)
  gameTime  String?   // e.g., "4:32" remaining in period

  isUndone  Boolean   @default(false)

  createdAt DateTime  @default(now())
  createdBy String?   // Scorekeeper user ID

  @@index([gameId, createdAt])
  @@map("stat_logs")
}

enum StatType {
  PTS_2      // 2-point field goal
  PTS_3      // 3-point field goal
  PTS_FT     // Free throw
  FG_MISS    // Missed field goal
  FG3_MISS   // Missed 3-pointer
  FT_MISS    // Missed free throw
  OREB       // Offensive rebound
  DREB       // Defensive rebound
  AST        // Assist
  STL        // Steal
  BLK        // Block
  TO         // Turnover
  FOUL       // Personal foul
}

// ============================================
// ACHIEVEMENTS & BADGES
// ============================================

model Achievement {
  id          String          @id @default(cuid())
  playerId    String
  player      Player          @relation(fields: [playerId], references: [id], onDelete: Cascade)

  type        AchievementType
  title       String          // Display title
  description String?

  // Context
  eventId     String?         // Which event this was earned at
  eventName   String?
  season      String?         // e.g., "2024-2025"

  earnedAt    DateTime        @default(now())

  @@map("achievements")
}

enum AchievementType {
  MVP
  ALL_TOURNAMENT
  CHAMPION
  STAT_LEADER
  DEFENSIVE_PLAYER
  MOST_IMPROVED
  SPORTSMANSHIP
  ALL_STAR
  TRIPLE_DOUBLE
  DOUBLE_DOUBLE
}

// ============================================
// MEDIA
// ============================================

model Media {
  id        String    @id @default(cuid())
  playerId  String
  player    Player    @relation(fields: [playerId], references: [id], onDelete: Cascade)

  type      MediaType
  url       String
  thumbnail String?

  title     String?
  description String?

  eventId   String?   // If from a specific event
  gameId    String?   // If from a specific game

  isPublic  Boolean   @default(true)
  isFeatured Boolean  @default(false)

  uploadedAt DateTime @default(now())

  @@map("media")
}

enum MediaType {
  PHOTO
  VIDEO
  HIGHLIGHT
}

// ============================================
// COLLEGE RECRUITING
// ============================================

model College {
  id          String   @id @default(cuid())
  name        String   // Mapped from 'School'
  slug        String   @unique
  division    String   // Mapped from 'Division'
  conference  String?  // Mapped from 'Conference'
  city        String?  // Mapped from 'City'
  state       String?  // Mapped from 'State'
  region      String?  // Mapped from 'Region'
  logo        String?

  coaches     CollegeCoach[]
  recruitingEmails RecruitingEmail[]
  eventRegistrations EventCollegeRegistration[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([name, state])
  @@map("colleges")
}

model CollegeCoach {
  id          String   @id @default(cuid())
  collegeId   String
  college     College  @relation(fields: [collegeId], references: [id], onDelete: Cascade)

  firstName   String   // Mapped from 'First name'
  lastName    String   // Mapped from 'Last name'
  title       String?  // Mapped from 'Position' (e.g. Head Coach)
  email       String?  // Mapped from 'Email address'
  phone       String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  recruitingEmails RecruitingEmail[]
  eventRegistrations EventCollegeRegistration[]

  @@map("college_coaches")
}

// ============================================
// RECRUITING EMAIL LOG
// ============================================

model RecruitingEmail {
  id          String        @id @default(cuid())
  sentById    String
  sentBy      User          @relation(fields: [sentById], references: [id])
  coachId     String?
  coach       CollegeCoach? @relation(fields: [coachId], references: [id])
  collegeId   String?
  college     College?      @relation(fields: [collegeId], references: [id])

  // Denormalized for display stability
  coachName   String
  coachEmail  String
  collegeName String

  sentAt      DateTime      @default(now())

  // Players included in this email (supports multi-player for directors)
  players     RecruitingEmailPlayer[]

  @@map("recruiting_emails")
}

model RecruitingEmailPlayer {
  id                String           @id @default(cuid())
  recruitingEmailId String
  recruitingEmail   RecruitingEmail  @relation(fields: [recruitingEmailId], references: [id], onDelete: Cascade)
  playerId          String
  player            Player           @relation(fields: [playerId], references: [id])

  @@unique([recruitingEmailId, playerId])
  @@map("recruiting_email_players")
}

// ============================================
// COLLEGE RECRUITING PACKET REGISTRATIONS
// ============================================

model EventCollegeRegistration {
  id              String   @id @default(cuid())
  eventId         String
  event           Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  // Coach info (denormalized + optional FK to CollegeCoach if matched)
  collegeCoachId  String?
  collegeCoach    CollegeCoach? @relation(fields: [collegeCoachId], references: [id])
  collegeId       String?
  college         College?      @relation(fields: [collegeId], references: [id])

  firstName       String
  lastName        String
  school          String   // Denormalized college name
  email           String   // .edu email
  division        String   // e.g., "Division I", "Division II"

  // Payment
  amountPaid      Decimal  @db.Decimal(10, 2)
  stripeSessionId String?
  stripePaymentId String?
  paymentStatus   PaymentStatus @default(PENDING)

  // Physical copy request
  wantsPhysicalCopy Boolean @default(false)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([eventId, email])
  @@map("event_college_registrations")
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

// ============================================
// WAITLIST
// ============================================

model Waitlist {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  source    String?
  createdAt DateTime @default(now())

  @@map("waitlist")
}
